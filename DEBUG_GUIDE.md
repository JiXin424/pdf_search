# 🔍 后端API调试指南

## 📋 调试功能总览

我已经为你的后端API添加了完整的调试监控系统，包含：

### 1. 🔧 调试中间件
- **自动记录所有HTTP请求和响应**
- **显示请求方法、路径、完整URL**
- **记录客户端信息和User-Agent**
- **计算并显示处理时间**
- **使用表情符号便于快速识别**

### 2. 📝 详细路由日志
- **聊天消息处理的完整流程追踪**
- **参数验证和处理步骤**
- **外部API调用详情（如果有截图）**
- **错误处理和异常捕获**

## 🚀 使用方法

### 启动调试模式
```bash
cd /Users/jixin/pdf_search/backend
python main.py
```

启动成功后会看到：
```
🔍 调试中间件已启用 - 将记录所有API请求和响应
INFO:     Uvicorn running on http://127.0.0.1:8001
```

### 测试API请求

#### 方法1: 使用curl测试
```bash
# 注意：需要先禁用代理
unset http_proxy https_proxy all_proxy

# 测试健康检查
curl http://127.0.0.1:8001/api/health

# 测试聊天接口
curl -X POST \\
  -F "message=测试消息" \\
  -F "timestamp=$(date -Iseconds)" \\
  http://127.0.0.1:8001/api/chat

# 测试聊天历史
curl http://127.0.0.1:8001/api/chat/history
```

#### 方法2: 使用前端界面
访问 http://localhost:3000 直接使用前端界面测试

#### 方法3: 使用测试脚本
```bash
python test_debug.py
```

## 📊 日志输出示例

### 中间件日志（所有请求）
```
================================================================================
🚀 [POST] /api/chat
📍 完整URL: http://127.0.0.1:8001/api/chat
🔗 客户端: 127.0.0.1:8001
🌐 User-Agent: curl/8.7.1...
✅ 响应状态: 200
⏱️  处理时间: 0.008秒
================================================================================
```

### 路由详细日志（聊天接口）
```
🎯 开始处理聊天消息
📝 消息内容: 这是一个测试消息
⏰ 时间戳: 2024-01-01T12:00:00
📸 截图文件: None
💾 用户消息已保存到历史，ID: 1
💬 处理纯文本聊天
🤖 AI回复已保存到历史，ID: 2
📤 回复内容: ✅ 聊天接口工作正常！...
✅ 聊天消息处理完成
```

### 视觉API调用日志（有截图时）
```
🖼️  检测到截图，准备调用视觉模型
📷 图片读取成功，大小: 12345 bytes
🔧 Base64编码完成，长度: 16460
🌐 准备调用外部API: https://qfgapi.com/v1/chat/completions
🤖 使用模型: gemini-2.5-pro-thinking
📡 API响应状态码: 200
✅ API调用成功，响应: {...}
```

## 🔧 调试技巧

### 1. 实时监控
在终端中运行后端，实时查看所有请求日志

### 2. 过滤特定日志
```bash
# 只看错误日志
python main.py 2>&1 | grep "❌"

# 只看API调用日志
python main.py 2>&1 | grep "🌐\\|📡"

# 只看处理时间
python main.py 2>&1 | grep "⏱️"
```

### 3. 保存日志到文件
```bash
python main.py > debug.log 2>&1
# 然后查看日志文件
tail -f debug.log
```

### 4. 网络问题诊断
如果遇到502错误，检查代理设置：
```bash
echo $http_proxy $https_proxy $all_proxy
# 如果有输出，临时禁用：
unset http_proxy https_proxy all_proxy
```

## 🎯 常见调试场景

### 1. API响应慢
- 查看 `⏱️ 处理时间` 日志
- 如果是视觉API调用慢，检查外部API状态

### 2. 参数错误
- 查看 `📝 消息内容` 和相关参数日志
- 检查参数验证日志

### 3. 外部API调用失败
- 查看 `📡 API响应状态码` 和错误响应
- 检查网络连接和API密钥

### 4. 文件上传问题
- 查看 `📸 截图文件` 和 `📷 图片读取成功` 日志
- 检查文件大小和格式

## 🛠 配置选项

### 禁用调试模式
在 `main.py` 中设置：
```python
os.environ["DEBUG"] = "false"
```

### 调整日志级别
在调试中间件中修改：
```python
logging.basicConfig(level=logging.WARNING)  # 只显示警告和错误
```

## 📱 移动端调试
对于移动端请求，在日志中查找对应的User-Agent来识别请求来源。

---

**现在你可以完全监控后端API的所有请求和响应！** 🎉